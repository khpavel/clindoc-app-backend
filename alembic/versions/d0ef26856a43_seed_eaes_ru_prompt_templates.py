"""seed_eaes_ru_prompt_templates

Revision ID: d0ef26856a43
Revises: 3a6c93eefa06
Create Date: 2025-12-05 01:34:56.118235

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa
import datetime as dt


# revision identifiers, used by Alembic.
revision: str = 'd0ef26856a43'
down_revision: Union[str, None] = '3a6c93eefa06'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None



def upgrade() -> None:
    templates_table = sa.table(
        "templates",
        sa.column("name", sa.String()),
        sa.column("description", sa.String()),
        sa.column("type", sa.String()),
        sa.column("section_code", sa.String()),
        sa.column("language", sa.String()),
        sa.column("scope", sa.String()),
        sa.column("content", sa.Text()),
        sa.column("variables", sa.JSON()),
        sa.column("is_default", sa.Boolean()),
        sa.column("is_active", sa.Boolean()),
        sa.column("version", sa.Integer()),
        sa.column("created_at", sa.DateTime()),
        sa.column("updated_at", sa.DateTime()),
        sa.column("created_by", sa.String()),
    )

    now = dt.datetime.utcnow()
    seed_author = "system_seed_eaes_ru_prompt"

    op.bulk_insert(
        templates_table,
        [
            # 1. SYNOPSIS
            {
                "name": "ЕАЭС/РФ – Prompt для сводки (SYNOPSIS)",
                "description": "Шаблон промпта для генерации краткой характеристики исследования (сводки) на русском языке.",
                "type": "prompt",
                "section_code": "SYNOPSIS",
                "language": "ru",
                "scope": "global",
                "content": (
                    "Ты – опытный медицинский писатель, готовящий клинический отчёт для досье ЕАЭС/РФ.\n"
                    "Твоя задача – подготовить раздел «Краткая характеристика исследования (Сводка)» для исследования "
                    "{{study_code}} по стандартам ICH E3 и требованиям регуляторов ЕАЭС/РФ.\n\n"
                    "ДОСТУПНЫЙ КОНТЕКСТ:\n"
                    "1) Краткая информация об исследовании и протоколе:\n"
                    "{{context_protocol}}\n\n"
                    "2) Статистический план / описание конечных точек:\n"
                    "{{context_sap}}\n\n"
                    "3) Сводка ключевых результатов (эффективность и безопасность):\n"
                    "{{context_tlf_summary}}\n\n"
                    "ОСНОВНЫЕ ТРЕБОВАНИЯ К ТЕКСТУ:\n"
                    "- Язык: русский, официальный, нейтральный, без маркетинговых формулировок.\n"
                    "- Стиль: связный текст (параграфы), без маркированных списков, если это прямо не следует из CONTEXT.\n"
                    "- Не выдумывай ни чисел, ни фактов: используй только то, что явно присутствует в контексте.\n"
                    "- Если каких-то данных не хватает, используй нейтральные формулировки вида "
                    "«данные не представлены в доступном контексте».\n\n"
                    "СТРУКТУРА СЕКЦИИ (РЕКОМЕНДАЦИЯ):\n"
                    "1) Краткое описание дизайна исследования (фаза, показание, тип дизайна, число пациентов).\n"
                    "2) Основная цель и ключевые вторичные цели исследования.\n"
                    "3) Основная конечная точка и ключевые вторичные конечные точки.\n"
                    "4) Краткое резюме ключевых результатов по эффективности.\n"
                    "5) Краткое резюме ключевых результатов по безопасности.\n"
                    "6) Итоговая фраза о ключевых выводах (без глубокого обсуждения соотношения польза/риск).\n\n"
                    "СФОРМИРУЙ ОДИН ЦЕЛЬНЫЙ ТЕКСТ РАЗДЕЛА СВОДКИ БЕЗ ЗАГОЛОВКОВ ПОДРАЗДЕЛОВ."
                ),
                "variables": {
                    "study_code": "Внутренний код исследования.",
                    "context_protocol": "Текст или выдержки из протокола/описания исследования.",
                    "context_sap": "Фрагменты статистического плана и описания конечных точек.",
                    "context_tlf_summary": "Сводка таблиц/листингов/графиков (основные результаты).",
                },
                "is_default": True,
                "is_active": True,
                "version": 1,
                "created_at": now,
                "updated_at": now,
                "created_by": seed_author,
            },

            # 2. OBJECTIVES
            {
                "name": "ЕАЭС/РФ – Prompt для целей и задач (OBJECTIVES)",
                "description": "Шаблон промпта для генерации раздела «Цели и задачи исследования».",
                "type": "prompt",
                "section_code": "OBJECTIVES",
                "language": "ru",
                "scope": "global",
                "content": (
                    "Ты – медицинский писатель, готовящий раздел «Цели и задачи исследования» для клинического "
                    "отчёта по требованиям ЕАЭС/РФ.\n\n"
                    "ДОСТУПНЫЙ КОНТЕКСТ:\n"
                    "1) Описание протокола и дизайна:\n"
                    "{{context_protocol}}\n\n"
                    "2) Формулировки целей и конечных точек из протокола и SAP:\n"
                    "{{context_sap}}\n\n"
                    "ЗАДАЧА:\n"
                    "- Сформулировать основной, вторичные и, при наличии, исследовательские цели исследования "
                    "на русском языке, используя формулировки, максимально близкие к утверждённому протоколу.\n\n"
                    "ТРЕБОВАНИЯ К ТЕКСТУ:\n"
                    "- Не выдумывай новые цели и конечные точки.\n"
                    "- При отсутствии явного указания цели или её формулировки используй нейтральную фразу "
                    "о том, что детали не представлены в доступном контексте.\n"
                    "- Раздели текст логически: сначала основная цель, затем ключевые вторичные цели, затем "
                    "исследовательские цели (если упомянуты в контексте).\n"
                    "- Стиль: формальный, ясный, без оценочных суждений.\n\n"
                    "СФОРМИРУЙ КОРОТКИЙ СВЯЗНЫЙ ТЕКСТ РАЗДЕЛА БЕЗ ВНУТРЕННИХ ПОДЗАГОЛОВКОВ."
                ),
                "variables": {
                    "context_protocol": "Фрагменты протокола с описанием целей.",
                    "context_sap": "Фрагменты SAP, где описаны цели и конечные точки.",
                },
                "is_default": True,
                "is_active": True,
                "version": 1,
                "created_at": now,
                "updated_at": now,
                "created_by": seed_author,
            },

            # 3. DESIGN
            {
                "name": "ЕАЭС/РФ – Prompt для описания дизайна (DESIGN)",
                "description": "Промпт для генерации раздела «Дизайн исследования».",
                "type": "prompt",
                "section_code": "DESIGN",
                "language": "ru",
                "scope": "global",
                "content": (
                    "Ты – опытный медицинский писатель. Тебе нужно подготовить раздел «Дизайн исследования» "
                    "для отчёта по клиническому исследованию в формате ЕАЭС/РФ.\n\n"
                    "КОНТЕКСТ ИЗ ПРОТОКОЛА И ДРУГИХ ДОКУМЕНТОВ:\n"
                    "{{context_protocol}}\n\n"
                    "ДОПОЛНИТЕЛЬНЫЕ СВЕДЕНИЯ (ПРИ НАЛИЧИИ):\n"
                    "{{context_sap}}\n\n"
                    "ЗАДАЧА:\n"
                    "- Сформулировать цельный текст, описывающий тип дизайна, ослепление, центры и страны, "
                    "схему рандомизации, периоды исследования и длительность участия пациента.\n\n"
                    "ТРЕБОВАНИЯ:\n"
                    "- Не выдумывай числа (N центров, N стран, длительности), если они прямо не указаны в контексте.\n"
                    "- Если конкретное значение отсутствует, используй формулировки наподобие "
                    "«точное количество центров не указано в доступном контексте».\n"
                    "- Структура текста должна следовать логике: тип исследования → рандомизация и ослепление → "
                    "центры/страны → периоды и длительность.\n"
                    "- Избегай списков, используй связный текст.\n\n"
                    "СФОРМИРУЙ ПОЛНЫЙ ТЕКСТ РАЗДЕЛА «ДИЗАЙН ИССЛЕДОВАНИЯ» БЕЗ МАРКЕРОВ И ТАБЛИЦ."
                ),
                "variables": {
                    "context_protocol": "Основные элементы дизайна из протокола.",
                    "context_sap": "Дополнительные детали по периодам и анализам (при наличии).",
                },
                "is_default": True,
                "is_active": True,
                "version": 1,
                "created_at": now,
                "updated_at": now,
                "created_by": seed_author,
            },

            # 4. DISPOSITION
            {
                "name": "ЕАЭС/РФ – Prompt для распределения пациентов (DISPOSITION)",
                "description": "Промпт для раздела о распределении пациентов и популяциях анализа.",
                "type": "prompt",
                "section_code": "DISPOSITION",
                "language": "ru",
                "scope": "global",
                "content": (
                    "Ты – медицинский писатель. Подготовь раздел, описывающий распределение пациентов по популяциям "
                    "и статус участия в исследовании (screened, randomized, ITT, PP и пр.).\n\n"
                    "КОНТЕКСТ ИЗ TLF И ПРОЧИХ ИСТОЧНИКОВ:\n"
                    "{{context_tlf_summary}}\n\n"
                    "ДОПОЛНИТЕЛЬНЫЕ ДАННЫЕ (ПРИ НАЛИЧИИ):\n"
                    "{{context_protocol}}\n\n"
                    "ЗАДАЧА:\n"
                    "- Кратко описать: сколько пациентов было скринировано, сколько рандомизировано, "
                    "сколько завершили лечение и сколько выбыли досрочно, с указанием основных причин.\n"
                    "- Определить, какие популяции использовались для анализа (ITT, PP, Safety) и их размеры.\n\n"
                    "ТРЕБОВАНИЯ:\n"
                    "- Не придумывай числа: опирайся только на контекст.\n"
                    "- Если какая-то популяция или число не указаны, честно напиши, что данные отсутствуют.\n"
                    "- Используй нейтральный, формальный стиль.\n\n"
                    "СФОРМИРУЙ СВЯЗНЫЙ ТЕКСТ РАЗДЕЛА «Распределение пациентов и популяции анализа» БЕЗ СПИСКОВ."
                ),
                "variables": {
                    "context_tlf_summary": "Таблицы/листинги по диспозиции пациентов.",
                    "context_protocol": "Описание популяций и критериев включения/исключения.",
                },
                "is_default": True,
                "is_active": True,
                "version": 1,
                "created_at": now,
                "updated_at": now,
                "created_by": seed_author,
            },

            # 5. EFFICACY_PRIMARY
            {
                "name": "ЕАЭС/РФ – Prompt для основных результатов эффективности (EFFICACY_PRIMARY)",
                "description": "Промпт для генерации текста по первичной конечной точке.",
                "type": "prompt",
                "section_code": "EFFICACY_PRIMARY",
                "language": "ru",
                "scope": "global",
                "content": (
                    "Ты – опытный медицинский писатель. "
                    "Нужно подготовить раздел, описывающий основные результаты по первичной конечной точке.\n\n"
                    "ДАННЫЕ ИЗ СТАТИСТИЧЕСКОГО АНАЛИЗА / TLF:\n"
                    "{{context_tlf_summary}}\n\n"
                    "СВЕДЕНИЯ ИЗ ПРОТОКОЛА И SAP:\n"
                    "{{context_protocol}}\n"
                    "{{context_sap}}\n\n"
                    "ЗАДАЧА:\n"
                    "- Чётко описать, что являлось первичной конечной точкой (полная формулировка и определение).\n"
                    "- Описать основные результаты анализа (значения в группах, разница между группами, ДИ, p-значение).\n"
                    "- Сделать короткий вывод о том, была ли достигнута целевая конечная точка (если это явно следует из данных).\n\n"
                    "ТРЕБОВАНИЯ:\n"
                    "- Используй только те числовые значения, которые есть в CONTEXT. Никакой генерации чисел.\n"
                    "- Если для какого-то параметра нет чисел, опиши результат качественно или укажи, что данные отсутствуют.\n"
                    "- Не делай детальный пересказ всех таблиц; сосредоточься на ключевых цифрах и выводе.\n"
                    "- Не используй жаргон, только формальный русский язык.\n\n"
                    "СФОРМИРУЙ СВЯЗНЫЙ ТЕКСТ, ПОДХОДЯЩИЙ ДЛЯ РАЗДЕЛА «Основные результаты по эффективности»."
                ),
                "variables": {
                    "context_tlf_summary": "Результаты по первичной конечной точке (таблицы, графики).",
                    "context_protocol": "Определение и описание первичной конечной точки.",
                    "context_sap": "Описание планового статистического анализа первичной конечной точки.",
                },
                "is_default": True,
                "is_active": True,
                "version": 1,
                "created_at": now,
                "updated_at": now,
                "created_by": seed_author,
            },

            # 6. SAFETY_OVERVIEW
            {
                "name": "ЕАЭС/РФ – Prompt для общей характеристики безопасности (SAFETY_OVERVIEW)",
                "description": "Промпт для генерации обобщающего раздела по безопасности.",
                "type": "prompt",
                "section_code": "SAFETY_OVERVIEW",
                "language": "ru",
                "scope": "global",
                "content": (
                    "Ты – медицинский писатель. "
                    "Необходимо подготовить обобщающий раздел по безопасности для досье ЕАЭС/РФ.\n\n"
                    "ДОСТУПНЫЕ ДАННЫЕ ПО БЕЗОПАСНОСТИ:\n"
                    "{{context_tlf_summary}}\n\n"
                    "ДОПОЛНИТЕЛЬНЫЙ КОНТЕКСТ:\n"
                    "{{context_protocol}}\n\n"
                    "ЗАДАЧА:\n"
                    "- Описать популяцию безопасности (кто в неё входит, N).\n"
                    "- Обозначить общую частоту НЯ в группах лечения.\n"
                    "- Кратко перечислить наиболее частые НЯ.\n"
                    "- Сделать общий вывод о профиле безопасности в сравнении с ранее известными данными, если это возможно.\n\n"
                    "ТРЕБОВАНИЯ:\n"
                    "- Не придумывай чисел и видов НЯ, если они не указаны.\n"
                    "- Если профиль безопасности явно не описан в контексте, используй осторожную формулировку "
                    "о том, что доступные данные ограничены.\n"
                    "- Стиль отчётный, без эмоциональных или оценочных прилагательных (кроме «благоприятный/приемлемый» "
                    "и аналогичных, если это следует из контекста).\n\n"
                    "РЕЗУЛЬТАТ: КОРОТКИЙ СВЯЗНЫЙ ТЕКСТ ДЛЯ РАЗДЕЛА «Общая характеристика безопасности»."
                ),
                "variables": {
                    "context_tlf_summary": "Ключевые таблицы/листинги по НЯ и популяции безопасности.",
                    "context_protocol": "Описание критериев популяции безопасности и общих ожиданий по профилю НЯ.",
                },
                "is_default": True,
                "is_active": True,
                "version": 1,
                "created_at": now,
                "updated_at": now,
                "created_by": seed_author,
            },

            # 7. SAFETY_SAE_DEATHS
            {
                "name": "ЕАЭС/РФ – Prompt для СНЯ и летальных исходов (SAFETY_SAE_DEATHS)",
                "description": "Промпт для раздела о серьёзных НЯ и летальных исходах.",
                "type": "prompt",
                "section_code": "SAFETY_SAE_DEATHS",
                "language": "ru",
                "scope": "global",
                "content": (
                    "Ты – медицинский писатель. "
                    "Подготовь раздел, посвящённый серьёзным нежелательным явлениям (СНЯ) и летальным исходам.\n\n"
                    "ДАННЫЕ ПО СНЯ И ЛЕТАЛЬНЫМ ИСХОДАМ:\n"
                    "{{context_tlf_summary}}\n\n"
                    "ДОПОЛНИТЕЛЬНЫЙ КОНТЕКСТ:\n"
                    "{{context_protocol}}\n\n"
                    "ЗАДАЧА:\n"
                    "- Кратко описать частоту СНЯ в группах.\n"
                    "- Перечислить наиболее частые СНЯ, если они указаны.\n"
                    "- Описать количество и возможную связь летальных исходов с терапией.\n"
                    "- Сформулировать вывод: есть ли новые/неожиданные сигналы безопасности.\n\n"
                    "ТРЕБОВАНИЯ:\n"
                    "- Избегай драматичных формулировок; используй нейтральный регуляторный язык.\n"
                    "- Не добавляй СНЯ или исходы, которых нет в данных.\n"
                    "- Если связь с лечением не указана, используй аккуратные формулировки "
                    "«связь с исследуемым препаратом не указана в доступном контексте».\n\n"
                    "СФОРМИРУЙ СВЯЗНЫЙ ТЕКСТ ДЛЯ РАЗДЕЛА О СНЯ И ЛЕТАЛЬНЫХ ИСХОДАХ."
                ),
                "variables": {
                    "context_tlf_summary": "Сводные таблицы по СНЯ и летальным исходам.",
                    "context_protocol": "Ожидаемые риски и специальные интересующие события, если указаны.",
                },
                "is_default": True,
                "is_active": True,
                "version": 1,
                "created_at": now,
                "updated_at": now,
                "created_by": seed_author,
            },

            # 8. DISCUSSION
            {
                "name": "ЕАЭС/РФ – Prompt для обсуждения и выводов (DISCUSSION)",
                "description": "Промпт для итогового раздела «Обсуждение и выводы» с акцентом на пользе/риске.",
                "type": "prompt",
                "section_code": "DISCUSSION",
                "language": "ru",
                "scope": "global",
                "content": (
                    "Ты – опытный медицинский писатель. "
                    "Нужно подготовить раздел «Обсуждение и выводы» для клинического отчёта по ЕАЭС/РФ.\n\n"
                    "КОНТЕКСТ ПО ЭФФЕКТИВНОСТИ:\n"
                    "{{context_efficacy}}\n\n"
                    "КОНТЕКСТ ПО БЕЗОПАСНОСТИ:\n"
                    "{{context_safety}}\n\n"
                    "ДОПОЛНИТЕЛЬНАЯ ИНФОРМАЦИЯ ИЗ ПРОТОКОЛА/ЛИТЕРАТУРЫ (ПРИ НАЛИЧИИ):\n"
                    "{{context_protocol}}\n\n"
                    "ЗАДАЧА:\n"
                    "- Кратко сопоставить результаты по эффективности и безопасности.\n"
                    "- Указать, была ли достигнута основная конечная точка и как вторичные результаты "
                    "соотносятся с первичными.\n"
                    "- Сформулировать вывод о соотношении польза/риск исследуемого препарата {{investigational_product_name}} "
                    "для популяции {{target_population_description}}.\n\n"
                    "ТРЕБОВАНИЯ:\n"
                    "- Не придумывай новых данных; опирайся только на предоставленный контекст.\n"
                    "- Если данных недостаточно для однозначного вывода, используй осторожные формулировки "
                    "о необходимости дополнительной оценки.\n"
                    "- Стиль: регуляторно-нейтральный, без рекламных утверждений.\n\n"
                    "СФОРМИРУЙ СВЯЗНЫЙ ТЕКСТ, ПОДХОДЯЩИЙ ДЛЯ РАЗДЕЛА «Обсуждение и выводы»."
                ),
                "variables": {
                    "context_efficacy": "Краткая сводка по результатам эффективности (первичная/вторичная).",
                    "context_safety": "Краткая сводка по безопасности.",
                    "context_protocol": "Ключевые положения протокола и обоснование исследования.",
                    "investigational_product_name": "Название исследуемого лекарственного препарата.",
                    "target_population_description": "Описание целевой популяции пациентов.",
                },
                "is_default": True,
                "is_active": True,
                "version": 1,
                "created_at": now,
                "updated_at": now,
                "created_by": seed_author,
            },
        ],
    )


def downgrade() -> None:
    op.execute(
        "DELETE FROM templates WHERE created_by = 'system_seed_eaes_ru_prompt'"
    )


